# 成交金额月分布  

	# 思路 成交金额应该是统计投资人，而且是属于累计金额 。
	# 有问题啊 显示的是每个月成交金额，没有做到这个月累计之前的月份 ？ 

 select 
  DATE_FORMAT( a.deal_time,'%Y / %m') ,
  sum(a.deal_amount)
   from  
  
  ( select 
	i.project_no,
	sum(i.amount) as deal_amount,
	l.PAYED_ON as deal_time
	
	from sp_investing i, sp_invest_project p,sp_loan_pay l
	where 1=1
	and i.project_no = l.project_no
	and i.project_no = p.PROJECT_NO
	and p.project_no not in (select project_no from sp_project_tag where tag=0) #tag，0 代表的是测试表
	and i.status in(2)		# -1-失败，0-等待确认，1-已确认，2-成功
	and p.STATUS in (3,4)		
	and l.PAYED_ON < now()	# 统计时间大于放款时间
	and l.PAYED_ON > DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
	group by i.project_no	
	order by deal_time desc									
   ) a  
   
   group by DATE_FORMAT(a.deal_time,'%Y%m')


<——start——>

SELECT
	SUBSTR(l.payed_on, 1, 7), SUM(p.total_amount)
FROM 	 
	sp_invest_project p
LEFT JOIN 
	(
	SELECT project_no, min(payed_on) AS payed_on
	From sp_loan_pay
	GROUP BY project_no
	) l
ON l.project_no = p.project_no
WHERE 1=1 
	AND p.project_no not in (select project_no from sp_project_tag where tag=0)
	AND p.project_type in (0,4,5)
	and p.status in (3,4)
	AND l.payed_on < @end_time
GROUP BY SUBSTR(l.payed_on, 1, 7);

<——end——>